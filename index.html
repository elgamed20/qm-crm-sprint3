<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QM Vendor/Client CRM — Sprint 5</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { background:#f8fafc; color:#0f172a; }
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;border:1px solid #cbd5e1;background:#fff;padding:.375rem .75rem;font-size:.875rem}
    .btn:hover{background:#f8fafc}
    .btn-primary{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;background:#0f172a;padding:.5rem 1rem;font-size:.875rem;color:#fff}
    .btn-primary:hover{background:#000}
    .btn-xs{display:inline-flex;align-items:center;justify-content:center;border-radius:.375rem;border:1px solid #cbd5e1;background:#fff;padding:.25rem .5rem;font-size:.75rem}
    .inp{width:100%;border:1px solid #cbd5e1;border-radius:.5rem;padding:.375rem .75rem;font-size:.875rem}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .card{border:1px solid #e2e8f0;background:#fff;border-radius:.75rem;padding:1rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .badge{display:inline-flex;align-items:center;border:1px solid #e2e8f0;border-radius:9999px;font-size:12px;padding:.125rem .5rem}
    .badge.gray{background:#f8fafc;color:#334155}
    .badge.amber{background:#fffbeb;color:#92400e;border-color:#f59e0b}
    .badge.green{background:#ecfdf5;color:#065f46;border-color:#34d399}
    .tabs button{border-radius:9999px;padding:.5rem 1rem;border:1px solid #cbd5e1}
    .tabs .active{background:#0f172a;color:#fff;border-color:#0f172a}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- === [APP] START === -->
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // ---------- Utils ----------
    const currencies = [
      { code: "KWD", label: "Kuwaiti Dinar" },
      { code: "EGP", label: "Egyptian Pound" },
      { code: "AED", label: "UAE Dirham" },
      { code: "USD", label: "US Dollar" },
    ];
    const countries = ["الكويت","مصر","الإمارات","أخرى"];
    const contractTypes = [
      { value:"monthly", label:"شهري" },
      { value:"milestone", label:"دفعات (Milestones)" },
      { value:"mixed", label:"مختلط" },
    ];
    const dueCategories = ["دفع","تسويق","خدمات","أخرى"];
    const payMethods = ["تحويل بنكي","كاش","شيك","بوابة دفع","أخرى"];
    const stages = ["New","Contacted","Negotiation","Won","Lost"];
    const importanceLabels = ["High","Medium","Low"];
    const currencyByCountry = {"الكويت":"KWD","مصر":"EGP","الإمارات":"AED"};
    const defaultCurrency = c => currencyByCountry[c] || "USD";
    const uid = () => Math.random().toString(36).slice(2,10);
    const fmt = (n, code="KWD") => {
      if (Number.isNaN(Number(n))) return "-";
      try { return new Intl.NumberFormat(undefined,{style:"currency",currency:code,maximumFractionDigits:3}).format(Number(n)); }
      catch { return Number(n).toFixed(2)+" "+code; }
    };
    const todayISO = () => new Date().toISOString().slice(0,10);

    // ---------- Local storage helpers ----------
    const STORAGE_KEY = "qm-crm-sprint5";
    const loadState = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    };
    const saveState = (state) => {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {}
    };

    // ---------- Seed ----------
    const seedClients = [
      { id: uid(), name: "Al Noor Clinic", country: "الكويت", phone: "22093334", email: "info@alnoor.kw", status: "current" },
      { id: uid(), name: "Delta Foods", country: "مصر", phone: "+2010000000", email: "ops@delta.eg",
        status: "prospect", salesOwner:"Omar", importance:"High", services:["Digital Marketing"], stage:"Negotiation",
        nextFollowUp:"", timeline:[] },
    ];
    const seedContracts = [
      { id: uid(), clientId: seedClients[0].id, service:"Marketing Retainer", type:"monthly", currency:"KWD",
        monthlyAmount:600, startDate:"2025-09-01", autoMonthly:true, billingDay:1, dueDay:5, createdAt:"2025-09-01" },
    ];
    const seedDue = [
      { id: uid(), clientId: seedClients[0].id, contractId: null, title:"اشتراك سبتمبر 2025",
        dueDate:"2025-09-05", amount:600, currency:"KWD", category:"دفع", allocated:0, status:"open" },
    ];
    const seedReceipts = [];

    // ---------- PDF helpers ----------
    const exportClientPDF = (client, contracts, dues, receipts, logo=null) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
      if (logo) doc.addImage(logo, "PNG", 40, 28, 90, 40);
      doc.setFontSize(16); doc.text("Client Statement", 140, 50);
      doc.setFontSize(11); doc.text(`Client: ${client.name}`, 40, 90);

      // Contracts
      let y = 110;
      doc.text("Contracts", 40, y);
      doc.autoTable({
        startY: y+10,
        head: [["Service","Type","Currency","Total/Monthly"]],
        body: contracts.map(ct => [
          ct.service || "-",
          ct.type,
          ct.currency,
          ct.type==="monthly" ? ct.monthlyAmount : (ct.total || (ct.milestones||[]).reduce((s,m)=>s+Number(m.amount||0),0) || 0)
        ])
      });

      // Dues
      y = doc.lastAutoTable.finalY + 20;
      doc.text("Dues", 40, y);
      doc.autoTable({
        startY: y+10,
        head: [["Title","Due Date","Amount","Status"]],
        body: dues.map(d => [d.title, d.dueDate, `${d.amount} ${d.currency}`, d.status])
      });

      // Receipts
      y = doc.lastAutoTable.finalY + 20;
      doc.text("Receipts", 40, y);
      doc.autoTable({
        startY: y+10,
        head: [["Date","Method","Amount","Reference","By"]],
        body: receipts.map(r => [r.receivedAt, r.method, `${r.amount} ${r.currency}`, r.reference||"-", r.createdBy||"-"])
      });

      const totalDue = dues.reduce((s,d)=> s + (Number(d.amount)-Number(d.allocated||0)), 0);
      const totalPaid = receipts.reduce((s,r)=> s + Number(r.amount), 0);
      const bal = totalDue - totalPaid;
      y = doc.lastAutoTable.finalY + 25;
      doc.setFontSize(12);
      doc.text(`Total Due: ${totalDue}`, 40, y);
      doc.text(`Total Paid: ${totalPaid}`, 180, y);
      doc.text(`Balance: ${bal}`, 320, y);

      doc.save(`${client.name}-statement.pdf`);
    };

    // ---------- Small UI ----------
    const Field = ({label,children}) => (
      <label className="grid gap-1 text-sm">
        <span className="text-slate-700 font-medium">{label}</span>
        {children}
      </label>
    );
    const Stat = ({label,value,subtle,highlight,good})=>{
      const cls = highlight? "bg-rose-50 border-rose-200": good? "bg-emerald-50 border-emerald-200": subtle? "bg-slate-50 border-slate-200":"bg-white border-slate-200";
      return <div className={"rounded-lg border p-3 text-center "+cls}>
        <div className="text-xs text-slate-600">{label}</div>
        <div className="text-base font-semibold">{value}</div>
      </div>;
    };
    const Th = ({children}) => <th className="px-3 py-2 text-xs font-semibold text-slate-600">{children}</th>;
    const Td = ({children}) => <td className="px-3 py-2">{children}</td>;
    const RowView = ({label,value}) => (
      <div className="flex items-center justify-between border-b py-2">
        <div className="text-sm text-slate-600">{label}</div>
        <div className="font-medium">{value || "—"}</div>
      </div>
    );
    const Modal = ({title,onClose,children}) => (
      <div className="modal" onMouseDown={onClose}>
        <div className="w-full max-w-2xl rounded-2xl bg-white border border-slate-200" onMouseDown={(e)=>e.stopPropagation()}>
          <div className="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <div className="font-semibold">{title}</div>
            <button className="text-slate-500 hover:text-slate-900" onClick={onClose}>✕</button>
          </div>
          <div className="p-4">{children}</div>
        </div>
      </div>
    );
    const ListTable = ({head,rows}) => (
      <div className="overflow-x-auto bg-white border rounded-xl">
        <table className="w-full text-sm">
          <thead className="bg-slate-50"><tr>{head.map((h,i)=><Th key={i}>{h}</Th>)}</tr></thead>
          <tbody>{rows.map((r,i)=>(<tr key={i} className="border-t">{r.map((c,j)=><Td key={j}>{c}</Td>)}</tr>))}</tbody>
        </table>
      </div>
    );

    // ---------- Forms ----------
    const ClientForm = ({ onSubmit, initial, onCancel }) => {
      const [name,setName]=useState(initial?.name||"");
      const [country,setCountry]=useState(initial?.country||countries[0]);
      const [phone,setPhone]=useState(initial?.phone||"");
      const [email,setEmail]=useState(initial?.email||"");
      const [isProspect,setIsProspect]=useState(initial? initial.status!=="current" : true);
      const [salesOwner,setSalesOwner]=useState(initial?.salesOwner||"");
      const [importance,setImportance]=useState(initial?.importance||"Medium");
      const [services,setServices]=useState(initial?.services||[]);
      const [stage,setStage]=useState(initial?.stage||"New");

      return (
        <form onSubmit={(e)=>{e.preventDefault();
            onSubmit({ name, country, phone, email, status: isProspect? "prospect":"current",
              salesOwner, importance, services, stage
            });
          }} className="grid gap-3">
          <Field label="اسم العميل"><input className="inp" value={name} onChange={e=>setName(e.target.value)} required/></Field>
          <div className="grid grid-cols-2 gap-3">
            <Field label="الدولة"><select className="inp" value={country} onChange={e=>setCountry(e.target.value)}>{countries.map(cc=><option key={cc}>{cc}</option>)}</select></Field>
            <Field label="Prospect?"><input type="checkbox" checked={isProspect} onChange={e=>setIsProspect(e.target.checked)} /></Field>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="هاتف"><input className="inp" value={phone} onChange={e=>setPhone(e.target.value)} /></Field>
            <Field label="إيميل"><input className="inp" value={email} onChange={e=>setEmail(e.target.value)} /></Field>
          </div>
          {isProspect && (
            <>
              <div className="grid grid-cols-3 gap-3">
                <Field label="Sales Owner"><input className="inp" value={salesOwner} onChange={e=>setSalesOwner(e.target.value)} /></Field>
                <Field label="Importance"><select className="inp" value={importance} onChange={e=>setImportance(e.target.value)}>{importanceLabels.map(i=><option key={i}>{i}</option>)}</select></Field>
                <Field label="Stage"><select className="inp" value={stage} onChange={e=>setStage(e.target.value)}>{stages.map(s=><option key={s}>{s}</option>)}</select></Field>
              </div>
              <Field label="Services (comma separated)"><input className="inp" value={services.join(", ")} onChange={e=>setServices(e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} /></Field>
            </>
          )}
          <div className="flex justify-end gap-2">
            {onCancel && <button type="button" className="btn" onClick={onCancel}>إلغاء</button>}
            <button type="submit" className="btn-primary">حفظ</button>
          </div>
        </form>
      );
    };

    const ContractForm = ({ clients=[], onSubmit, initial, onCancel }) => {
      const [clientId,setClientId]=useState(initial?.clientId || (clients[0]?.id||""));
      const [service,setService]=useState(initial?.service||"");
      const [type,setType]=useState(initial?.type||"monthly");
      const [currency,setCurrency]=useState(initial?.currency||"KWD");
      const [monthlyAmount,setMonthlyAmount]=useState(initial?.monthlyAmount||600);
      const [startDate,setStartDate]=useState(initial?.startDate||"");
      const [endDate,setEndDate]=useState(initial?.endDate||"");
      const [autoMonthly,setAutoMonthly]=useState(!!initial?.autoMonthly);
      const [billingDay,setBillingDay]=useState(initial?.billingDay||1);
      const [dueDay,setDueDay]=useState(initial?.dueDay||5);
      const [milestones,setMilestones]=useState(initial?.milestones||[]);
      const addMilestone = ()=> setMilestones(p=>[...p, {id:uid(), title:"", amount:0, dueDate:"", status:"open", allocated:0}]);
      const setM = (i, patch)=> setMilestones(p=>p.map((m,idx)=> idx===i? {...m, ...patch}:m));
      const delM = (i)=> setMilestones(p=>p.filter((_,idx)=> idx!==i));

      return (
        <form onSubmit={(e)=>{ e.preventDefault();
            if(!clientId) return alert("اختر عميلًا");
            const payload={ clientId, service, type, currency, startDate, endDate, autoMonthly,
              billingDay:Number(billingDay), dueDay:Number(dueDay) };
            if (type==="monthly") payload.monthlyAmount=Number(monthlyAmount);
            if (type==="milestone") payload.milestones=milestones;
            onSubmit(payload);
          }} className="grid gap-3">
          {!!clients.length && <Field label="العميل"><select className="inp" value={clientId} onChange={e=>setClientId(e.target.value)}>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></Field>}
          <Field label="نوع الخدمة"><input className="inp" value={service} onChange={e=>setService(e.target.value)} placeholder="مثال: Social Media, SEO..." /></Field>
          <div className="grid grid-cols-2 gap-3">
            <Field label="نوع العقد"><select className="inp" value={type} onChange={e=>setType(e.target.value)}>{contractTypes.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select></Field>
            <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
          </div>
          {type==="monthly" && <Field label="قيمة الاشتراك الشهري"><input type="number" className="inp" value={monthlyAmount} onChange={e=>setMonthlyAmount(e.target.value)} /></Field>}
          <div className="grid grid-cols-2 gap-3">
            <Field label="تاريخ البداية"><input type="date" className="inp" value={startDate} onChange={e=>setStartDate(e.target.value)} /></Field>
            <Field label="تاريخ النهاية"><input type="date" className="inp" value={endDate} onChange={e=>setEndDate(e.target.value)} /></Field>
          </div>
          {type!=="milestone" && (
            <div className="grid grid-cols-3 gap-3">
              <Field label="توليد تلقائي"><input type="checkbox" checked={autoMonthly} onChange={e=>setAutoMonthly(e.target.checked)} /></Field>
              <Field label="يوم الإصدار"><input type="number" className="inp" value={billingDay} onChange={e=>setBillingDay(e.target.value)} /></Field>
              <Field label="يوم الاستحقاق"><input type="number" className="inp" value={dueDay} onChange={e=>setDueDay(e.target.value)} /></Field>
            </div>
          )}
          {type==="milestone" && (
            <div className="grid gap-2">
              <div className="flex items-center justify-between">
                <div className="font-semibold">دفعات (Milestones)</div>
                <button type="button" className="btn" onClick={addMilestone}>+ Add milestone</button>
              </div>
              {milestones.length===0 && <div className="text-sm text-slate-500">لا توجد دفعات بعد.</div>}
              {milestones.map((m,i)=>(
                <div key={m.id} className="grid grid-cols-5 gap-2 items-end">
                  <Field label="Title"><input className="inp" value={m.title} onChange={e=>setM(i,{title:e.target.value})} /></Field>
                  <Field label="Due Date"><input type="date" className="inp" value={m.dueDate} onChange={e=>setM(i,{dueDate:e.target.value})} /></Field>
                  <Field label="Amount"><input type="number" className="inp" value={m.amount} onChange={e=>setM(i,{amount:Number(e.target.value)})} /></Field>
                  <Field label="Status"><select className="inp" value={m.status} onChange={e=>setM(i,{status:e.target.value})}><option>open</option><option>partial</option><option>paid</option></select></Field>
                  <button type="button" className="btn" onClick={()=>delM(i)}>حذف</button>
                </div>
              ))}
            </div>
          )}
          <div className="flex justify-end gap-2">
            {onCancel && <button type="button" className="btn" onClick={onCancel}>إلغاء</button>}
            <button type="submit" className="btn-primary">حفظ</button>
          </div>
        </form>
      );
    };

    const DueForm = ({ clients, onSubmit, initial={} }) => {
      const [clientId, setClientId] = useState(initial.clientId || (clients[0]?.id || ""));
      const [title, setTitle] = useState(initial.title || "");
      const [dueDate, setDueDate] = useState(initial.dueDate || "");
      const [amount, setAmount] = useState(initial.amount || 0);
      const [currency, setCurrency] = useState(initial.currency || (clients[0] ? defaultCurrency(clients[0].country) : "KWD"));
      const [category, setCategory] = useState(initial.category || "دفع");
      return (
        <form onSubmit={(e)=>{e.preventDefault();
            if(!clientId) return alert("اختر العميل");
            if(!title.trim()) return alert("الوصف مطلوب");
            onSubmit({ id:uid(), clientId, title, dueDate, amount:Number(amount), currency, category, allocated:0, status:"open" });
          }} className="grid gap-3">
          <Field label="العميل"><select className="inp" value={clientId} onChange={e=>{ setClientId(e.target.value); const c=clients.find(x=>x.id===e.target.value); if(c) setCurrency(defaultCurrency(c.country)); }}>
            {clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select></Field>
          <Field label="الوصف"><input className="inp" value={title} onChange={e=>setTitle(e.target.value)} /></Field>
          <Field label="تاريخ الاستحقاق"><input type="date" className="inp" value={dueDate} onChange={e=>setDueDate(e.target.value)} /></Field>
          <Field label="القيمة"><input type="number" className="inp" value={amount} onChange={e=>setAmount(e.target.value)} /></Field>
          <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
          <Field label="التصنيف"><select className="inp" value={category} onChange={e=>setCategory(e.target.value)}>{dueCategories.map(x=><option key={x} value={x}>{x}</option>)}</select></Field>
          <div className="flex justify-end"><button type="submit" className="btn-primary">حفظ</button></div>
        </form>
      );
    };

    const ReceiptForm = ({ clients, dueItems, onSubmit, initial={} }) => {
      const [clientId, setClientId] = useState(initial.clientId || (clients[0]?.id || ""));
      const [amount, setAmount] = useState(initial.amount || 0);
      const [currency, setCurrency] = useState(initial.currency || (clients[0]? defaultCurrency(clients[0].country):"KWD"));
      const [method, setMethod] = useState(initial.method || payMethods[0]);
      const [reference, setReference] = useState(initial.reference || "");
      const [receivedAt, setReceivedAt] = useState(initial.receivedAt || todayISO());
      const [note, setNote] = useState(initial.note || "");
      const [attachmentUrl, setAttachmentUrl] = useState(initial.attachmentUrl || "");
      const [appliedToDueItemId, setAppliedToDueItemId] = useState(initial.appliedToDueItemId || "");

      return (
        <form onSubmit={(e)=>{ e.preventDefault();
            if(!clientId) return alert("اختر العميل");
            if(Number(amount)<=0) return alert("القيمة غير صالحة");
            if(!attachmentUrl) return alert("إثبات الدفع إلزامي");
            onSubmit({
              clientId, amount:Number(amount), currency, method, reference, receivedAt, note,
              attachmentUrl, appliedToDueItemId: appliedToDueItemId || null
            });
          }} className="grid gap-3">
          <Field label="العميل"><select className="inp" value={clientId} onChange={e=>{ setClientId(e.target.value); const c=clients.find(x=>x.id===e.target.value); if(c) setCurrency(defaultCurrency(c.country)); }}>
            {clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select></Field>
          <div className="grid grid-cols-2 gap-3">
            <Field label="القيمة"><input type="number" className="inp" value={amount} onChange={e=>setAmount(e.target.value)} /></Field>
            <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="طريقة الدفع"><select className="inp" value={method} onChange={e=>setMethod(e.target.value)}>{payMethods.map(m=><option key={m}>{m}</option>)}</select></Field>
            <Field label="مرجع"><input className="inp" value={reference} onChange={e=>setReference(e.target.value)} placeholder="رقم تحويل/شيك" /></Field>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="تاريخ التحصيل"><input type="date" className="inp" value={receivedAt} onChange={e=>setReceivedAt(e.target.value)} /></Field>
            <Field label="ملاحظة"><input className="inp" value={note} onChange={e=>setNote(e.target.value)} placeholder="اختياري" /></Field>
          </div>
          <Field label="مرفق (صورة/PDF)">
            <input type="file" accept="image/*,application/pdf" className="inp"
              onChange={(e)=>{const f=e.target.files?.[0]; if(f) setAttachmentUrl(URL.createObjectURL(f));}} />
          </Field>
          <Field label="تطبيق التحصيل على مستحق معيّن (اختياري)">
            <select className="inp" value={appliedToDueItemId} onChange={e=>setAppliedToDueItemId(e.target.value)}>
              <option value="">— لا يوجد —</option>
              {dueItems.filter(d=>d.clientId===clientId).map(d=><option key={d.id} value={d.id}>{d.title}</option>)}
            </select>
          </Field>
          <div className="flex justify-end"><button type="submit" className="btn-primary">حفظ</button></div>
        </form>
      );
    };

    // ---------- Views ----------
    const ContractView = ({ ct, editable, onEdit }) => {
      const [edit,setEdit]=useState(false);
      if (!edit) {
        return (
          <div className="grid gap-2">
            <RowView label="Service" value={ct.service||"—"} />
            <RowView label="Type" value={ct.type} />
            <RowView label="Currency" value={ct.currency} />
            {ct.type==="monthly" && <RowView label="Monthly Amount" value={ct.monthlyAmount} />}
            <RowView label="Start" value={ct.startDate||"—"} />
            <RowView label="End" value={ct.endDate||"—"} />
            {ct.type==="milestone" && (
              <div className="mt-2">
                <div className="font-semibold mb-1">Milestones</div>
                <ListTable head={["Title","Due","Amount","Status"]} rows={(ct.milestones||[]).map(m=>[m.title, m.dueDate, m.amount, m.status||"open"])} />
              </div>
            )}
            {editable && <div className="flex justify-end"><button className="btn" onClick={()=>setEdit(true)}>Edit</button></div>}
          </div>
        );
      }
      return <ContractForm initial={ct} onSubmit={(val)=>{ onEdit && onEdit(val); setEdit(false); }} onCancel={()=>setEdit(false)} />;
    };

    const ProspectTimeline = ({ c, updateClient })=>{
      const [comment, setComment] = useState("");
      const [follow, setFollow] = useState(c.nextFollowUp||"");
      const addComment = ()=>{
        const t = c.timeline? [...c.timeline]:[];
        t.unshift({ id:uid(), at:new Date().toISOString(), text:comment });
        updateClient({ timeline:t });
        setComment("");
      };
      const saveFollow = ()=> updateClient({ nextFollowUp: follow });
      const overdue = c.nextFollowUp && new Date(c.nextFollowUp) < new Date();
      return (
        <div className="grid gap-3">
          <Field label="إضافة تعليق"><textarea className="inp" rows="3" value={comment} onChange={e=>setComment(e.target.value)} /></Field>
          <div className="flex justify-end"><button className="btn" onClick={addComment} disabled={!comment.trim()}>إضافة تعليق</button></div>
          <Field label="المتابعة القادمة">
            <input type="datetime-local" className={"inp "+(overdue?"border-rose-400":"")} value={follow} onChange={e=>setFollow(e.target.value)} />
          </Field>
          <div className="flex justify-end"><button className="btn" onClick={saveFollow}>حفظ المتابعة</button></div>
          <div className="grid gap-2">{(c.timeline||[]).map(t=>(<div key={t.id} className="border rounded p-2 text-sm"><b>{new Date(t.at).toLocaleString()}</b><br/>{t.text}</div>))}</div>
        </div>
      );
    };

    const ClientView = ({ c, contracts, dueItems, receipts, onClose, updateClient })=>{
      const [edit,setEdit]=useState(false);
      const [tab,setTab]=useState(c.status==="current"?"contracts":"timeline");
      const onPatch = (patch)=> updateClient(patch);

      return (
        <Modal title={"تفاصيل العميل — "+c.name} onClose={onClose}>
          {!edit ? (
            <div className="grid gap-3">
              <RowView label="الدولة" value={c.country} />
              <RowView label="هاتف" value={c.phone} />
              <RowView label="إيميل" value={c.email} />
              {c.status!=="current" && (
                <>
                  <RowView label="Sales Owner" value={c.salesOwner||"—"} />
                  <RowView label="Importance" value={c.importance||"—"} />
                  <RowView label="Services" value={(c.services||[]).join(", ")||"—"} />
                  <RowView label="Stage" value={c.stage||"—"} />
                  <RowView label="Next Follow-up" value={c.nextFollowUp||"—"} />
                </>
              )}
              <div className="flex items-center gap-2 mt-2">
                <button className="btn" onClick={()=>setEdit(true)}>تعديل</button>
              </div>
              <div className="mt-2">
                <div className="tabs mb-3">
                  {c.status==="current" && <button className={tab==="contracts"?"active":""} onClick={()=>setTab("contracts")}>العقود</button>}
                  {c.status==="current" && <button className={tab==="dues"?"active":""} onClick={()=>setTab("dues")}>المستحقات</button>}
                  {c.status==="current" && <button className={tab==="receipts"?"active":""} onClick={()=>setTab("receipts")}>التحصيل</button>}
                  <button className={tab==="timeline"?"active":""} onClick={()=>setTab("timeline")}>الملاحظات والمتابعة</button>
                </div>
                {tab==="contracts" && <div className="grid gap-2">{contracts.map(ct=> <ContractView key={ct.id} ct={ct} />)}</div>}
                {tab==="dues" && <ListTable rows={dueItems.map(d=>[d.title,d.dueDate,fmt(d.amount,d.currency),d.status])} head={["الوصف","تاريخ","المبلغ","الحالة"]} />}
                {tab==="receipts" && <ListTable rows={receipts.map(r=>[r.receivedAt,r.method,fmt(r.amount,r.currency), r.createdBy])} head={["تاريخ","طريقة","المبلغ","المستخدم"]} />}
                {tab==="timeline" && <ProspectTimeline c={c} updateClient={onPatch} />}
              </div>
            </div>
          ):(
            <ClientForm initial={c} onSubmit={(val)=>{ onPatch(val); setEdit(false); }} onCancel={()=>setEdit(false)} />
          )}
        </Modal>
      );
    };

    // ---------- Panels ----------
    const ClientsPanel = ({ clients, allClients, setClients, statsByClient, addClient, updateClient, clientTab, setClientTab, contracts, addContract, dueItems, addDue, receipts, exportClient })=>{
      const [openAdd,setOpenAdd]=useState(false);
      return (
        <section className="pt-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-xl font-semibold">العملاء</h2>
            <div className="flex items-center gap-2">
              <div className="tabs">
                <button className={clientTab==="current"?"active":""} onClick={()=>setClientTab("current")}>عملاء حاليين</button>
                <button className={clientTab==="prospects"?"active":""} onClick={()=>setClientTab("prospects")}>عملاء محتملين</button>
                <button className={clientTab==="all"?"active":""} onClick={()=>setClientTab("all")}>كل العملاء</button>
              </div>
              <button className="btn-primary" onClick={()=>setOpenAdd(true)}>إضافة عميل</button>
            </div>
          </div>

          <div className="grid gap-3">
            {clients.map(c => (
              <ClientCard
                key={c.id}
                c={c}
                stats={statsByClient[c.id]||{}}
                contracts={contracts.filter(ct=>ct.clientId===c.id)}
                dueItems={dueItems.filter(d=>d.clientId===c.id)}
                receipts={receipts.filter(r=>r.clientId===c.id)}
                onExport={()=>exportClient(c.id)}
                onAddDue={(d)=>addDue({...d, clientId:c.id, currency: defaultCurrency(c.country)})}
                onAddContract={(ct)=>addContract({...ct, clientId:c.id, currency: defaultCurrency(c.country)})}
                updateClient={(patch)=>updateClient(c.id, patch)}
              />
            ))}
          </div>

          {openAdd && (
            <Modal title="إضافة عميل" onClose={()=>setOpenAdd(false)}>
              <ClientForm onSubmit={(val)=>{ addClient({ id:uid(), status: (val.status||"prospect"), ...val }); setOpenAdd(false); }} />
            </Modal>
          )}
        </section>
      );
    };

    const ClientCard = ({ c, stats, contracts, dueItems, receipts, onExport, onAddDue, onAddContract, updateClient })=>{
      const [showView, setShowView]=useState(false);
      const [showAddDue, setShowAddDue]=useState(false);
      const [showAddContract, setShowAddContract]=useState(false);
      return (
        <div className="card">
          <div className="flex items-start gap-4">
            <div className="flex-1">
              <div className="flex items-center gap-2">
                <h3 className="text-lg font-semibold">{c.name}</h3>
                <span className="badge gray">{c.country}</span>
                <span className={"badge "+(c.status==="current"?"green":c.status==="prospect"?"amber":"gray")}>{c.status==="current"?"حالي":"محتمل"}</span>
                {/* NEW: service badge for prospects */}
                {c.status==="prospect" && Array.isArray(c.services) && c.services.length>0 && (
                  <span className="badge">{c.services[0]}</span>
                )}
              </div>
              <div className="text-sm text-slate-600">{c.email} · {c.phone}</div>
            </div>
            {c.status==="current" && (
              <div className="grid grid-cols-3 gap-3">
                <Stat label="إجمالي مستحق" value={fmt(stats.due || 0, stats.currency||defaultCurrency(c.country))} subtle />
                <Stat label="إجمالي مدفوع" value={fmt(stats.paid || 0, stats.currency||defaultCurrency(c.country))} />
                <Stat label="الرصيد" value={fmt(stats.balance || 0, stats.currency||defaultCurrency(c.country))} highlight={(stats.balance||0)>0} good={(stats.balance||0)<=0} />
              </div>
            )}
          </div>

          <div className="mt-4 flex items-center gap-2">
            <button className="btn" onClick={()=>setShowView(true)}>عرض التفاصيل</button>
            {c.status==="current" && <>
              <button className="btn" onClick={()=>setShowAddDue(true)}>+ إضافة مستحق</button>
              <button className="btn" onClick={()=>setShowAddContract(true)}>+ عقد جديد</button>
              <button className="btn" onClick={onExport}>تصدير كشف PDF</button>
            </>}
          </div>

          {showView && (
            <ClientView
              c={c}
              contracts={contracts}
              dueItems={dueItems}
              receipts={receipts}
              onClose={()=>setShowView(false)}
              updateClient={(patch)=>updateClient(patch)}
            />
          )}

          {showAddDue && (
            <Modal title="إضافة مستحق" onClose={()=>setShowAddDue(false)}>
              <DueForm clients={[c]} onSubmit={(d)=>{ onAddDue(d); setShowAddDue(false); }} />
            </Modal>
          )}

          {showAddContract && (
            <Modal title="إضافة عقد" onClose={()=>setShowAddContract(false)}>
              <ContractForm onSubmit={(ct)=>{ onAddContract(ct); setShowAddContract(false); }} clients={[c]} />
            </Modal>
          )}
        </div>
      );
    };

    const ContractsPanel = ({ clients, contracts, addContract, updateContract })=>{
      const [openAdd,setOpenAdd]=useState(false);
      const [view,setView]=useState(null);
      return (
        <section className="pt-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-xl font-semibold">العقود</h2>
            <button className="btn-primary" onClick={()=>setOpenAdd(true)}>إضافة عقد</button>
          </div>
          <div className="grid gap-3">
            {contracts.map(ct=>{
              const cl = clients.find(c=>c.id===ct.clientId);
              return (
                <div key={ct.id} className="card">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-semibold">{cl?.name} · <span className="text-slate-600">{ct.service||"—"}</span></div>
                      <div className="text-sm text-slate-600">{ct.type} · {ct.currency} · {ct.startDate||"—"} → {ct.endDate||"—"}</div>
                    </div>
                    <button className="btn" onClick={()=>setView(ct)}>View</button>
                  </div>
                </div>
              );
            })}
          </div>

          {openAdd && <Modal title="إضافة عقد" onClose={()=>setOpenAdd(false)}><ContractForm clients={clients} onSubmit={(val)=>{ addContract(val); setOpenAdd(false); }} /></Modal>}
          {view && <Modal title="عرض العقد" onClose={()=>setView(null)}><ContractView ct={view} editable onEdit={(patch)=>{ updateContract(view.id, patch); setView(null); }} /></Modal>}
        </section>
      );
    };

    const DuesPanel = ({ clients, dueItems, addDueItem, alloc })=>{
      const [openAdd,setOpenAdd]=useState(false);
      const [clientFilter,setClientFilter]=useState("");
      const list = useMemo(()=> clientFilter? dueItems.filter(d=>d.clientId===clientFilter): dueItems, [clientFilter, dueItems]);
      const isOverdue = (d) => d.status!=="paid" && d.dueDate && new Date(d.dueDate) < new Date();
      return (
        <section className="pt-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-xl font-semibold">المستحقات</h2>
            <div className="flex items-center gap-2">
              <select className="inp" value={clientFilter} onChange={e=>setClientFilter(e.target.value)}>
                <option value="">كل العملاء</option>
                {clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <button className="btn-primary" onClick={()=>setOpenAdd(true)}>إضافة مستحق</button>
            </div>
          </div>
          <div className="overflow-x-auto bg-white border rounded-xl">
            <table className="w-full text-sm">
              <thead className="bg-slate-50"><tr className="text-left"><Th>العميل</Th><Th>الوصف</Th><Th>الفئة</Th><Th>تاريخ</Th><Th>القيمة</Th><Th>محجوز</Th><Th>الحالة</Th><Th>إجراءات</Th></tr></thead>
              <tbody>
                {list.map(d=>{
                  const cl = clients.find(c=>c.id===d.clientId);
                  return (
                    <tr key={d.id} className={"border-t "+(isOverdue(d)?"bg-rose-50":"")}>
                      <Td>{cl?.name}</Td><Td>{d.title}</Td><Td>{d.category}</Td><Td>{d.dueDate||"—"}</Td><Td>{fmt(d.amount,d.currency)}</Td><Td>{fmt(d.allocated||0,d.currency)}</Td>
                      <Td>{d.status}</Td>
                      <Td><button className="btn-xs" onClick={()=>{ const v=prompt("قيمة التخصيص","0"); if(!v) return; alloc(d.id, Number(v)); }}>تخصيص</button></Td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          {openAdd && <Modal title="إضافة مستحق" onClose={()=>setOpenAdd(false)}><DueForm clients={clients} onSubmit={(d)=>{ addDueItem(d); setOpenAdd(false); }} /></Modal>}
        </section>
      );
    };

    const ReceiptsPanel = ({ clients, receipts, addReceipt, dueItems })=>{
      const [openAdd,setOpenAdd]=useState(false);
      const [clientFilter, setClientFilter]=useState("");
      const list = useMemo(()=> clientFilter? receipts.filter(r=>r.clientId===clientFilter): receipts, [clientFilter, receipts]);
      return (
        <section className="pt-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-xl font-semibold">التحصيل</h2>
            <div className="flex items-center gap-2">
              <select className="inp" value={clientFilter} onChange={e=>setClientFilter(e.target.value)}>
                <option value="">كل العملاء</option>
                {clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <button className="btn-primary" onClick={()=>setOpenAdd(true)}>تسجيل تحصيل</button>
            </div>
          </div>
          <div className="overflow-x-auto bg-white border rounded-xl">
            <table className="w-full text-sm">
              <thead className="bg-slate-50"><tr><Th>العميل</Th><Th>التاريخ</Th><Th>القيمة</Th><Th>الطريقة</Th><Th>مرجع</Th><Th>ملاحظة</Th><Th>مرفق</Th><Th>المستخدم</Th></tr></thead>
              <tbody>
                {list.map(r=>{
                  const cl = clients.find(c=>c.id===r.clientId);
                  return (<tr key={r.id} className="border-t"><Td>{cl?.name}</Td><Td>{r.receivedAt}</Td><Td>{fmt(r.amount, r.currency)}</Td><Td>{r.method}</Td><Td>{r.reference||"—"}</Td><Td>{r.note||"—"}</Td><Td>{r.attachmentUrl? <a className="underline" href={r.attachmentUrl} target="_blank">عرض</a>:"—"}</Td><Td>{r.createdBy}</Td></tr>);
                })}
              </tbody>
            </table>
          </div>
          {openAdd && <Modal title="تسجيل تحصيل" onClose={()=>setOpenAdd(false)}><ReceiptForm clients={clients} dueItems={dueItems} onSubmit={(val)=>{ addReceipt(val); setOpenAdd(false); }} /></Modal>}
        </section>
      );
    };

    const ReportsPanel = ({ clients, dueItems, receipts, exportPDF })=>{
      const [fromDate, setFromDate] = useState("");
      const [toDate, setToDate] = useState("");
      const [country, setCountry] = useState("");
      const [currency, setCurrency] = useState("");
      const [category, setCategory] = useState("");
      const [user, setUser] = useState("");

      const inRange = (d) => {
        if(!d) return true;
        const t = new Date(d).getTime();
        if(fromDate && t < new Date(fromDate).getTime()) return false;
        if(toDate && t > new Date(toDate).getTime()) return false;
        return true;
      };

      const filteredDues = dueItems.filter(d => inRange(d.dueDate) && (!currency || d.currency===currency) && (!category || d.category===category) && (!country || (clients.find(c=>c.id===d.clientId)?.country===country)));
      const filteredReceipts = receipts.filter(r => inRange(r.receivedAt) && (!currency || r.currency===currency) && (!user || r.createdBy===user) && (!country || (clients.find(c=>c.id===r.clientId)?.country===country)));

      const totalDue = filteredDues.reduce((s,d)=> s + (Number(d.amount) - Number(d.allocated||0)), 0);
      const totalPaid = filteredReceipts.reduce((s,r)=> s + Number(r.amount), 0);
      const balance = totalDue - totalPaid;

      const rows = [
        ["Type","Date","Client","Desc/Method","Amount","Currency","User/Category"],
        ...filteredDues.map(d=>["Due", d.dueDate||"", (clients.find(c=>c.id===d.clientId)||{}).name||"", d.title, d.amount, d.currency, d.category]),
        ...filteredReceipts.map(r=>["Receipt", r.receivedAt||"", (clients.find(c=>c.id===r.clientId)||{}).name||"", r.method, r.amount, r.currency, r.createdBy])
      ];

      return (
        <section className="pt-6">
          <h2 className="text-xl font-semibold mb-3">التقارير</h2>
          <div className="grid md:grid-cols-5 gap-2 mb-4">
            <Field label="من"><input type="date" className="inp" value={fromDate} onChange={e=>setFromDate(e.target.value)} /></Field>
            <Field label="إلى"><input type="date" className="inp" value={toDate} onChange={e=>setToDate(e.target.value)} /></Field>
            <Field label="الدولة"><select className="inp" value={country} onChange={e=>setCountry(e.target.value)}><option value="">الكل</option>{countries.map(c=><option key={c} value={c}>{c}</option>)}</select></Field>
            <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}><option value="">الكل</option>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
            <Field label="تصنيف/مستخدم"><input className="inp" placeholder="تصنيف (Due) أو مستخدم (Receipt)" value={user||category} onChange={e=>{ setUser(e.target.value); setCategory(e.target.value); }} /></Field>
          </div>
          <div className="flex items-center gap-2 mb-4">
            <button className="btn" onClick={()=>{setFromDate(""); setToDate(""); setCountry(""); setCurrency(""); setCategory(""); setUser("");}}>الكل</button>
            <button className="btn-primary" onClick={()=>exportPDF(rows,"Reports")}>تصدير PDF</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
            <Stat label="إجمالي مستحق" value={fmt(totalDue, currency||"KWD")} subtle/>
            <Stat label="إجمالي مدفوع" value={fmt(totalPaid, currency||"KWD")}/>
            <Stat label="الرصيد الإجمالي" value={fmt(balance, currency||"KWD")} highlight={balance>0} good={balance<=0}/>
          </div>
        </section>
      );
    };

    // ---------- App ----------
    function App(){
      const [tab, setTab] = useState("clients");
      const [logoDataUrl, setLogoDataUrl] = useState(null);
      const [search, setSearch] = useState("");
      const [clientTab, setClientTab] = useState("current");
      const currentUser = "Yasser";

      // state load (localStorage or seed)
      const loaded = loadState();
      const [clients, setClients] = useState(loaded?.clients || seedClients);
      const [contracts, setContracts] = useState(loaded?.contracts || seedContracts);
      const [dueItems, setDueItems] = useState(loaded?.dueItems || seedDue);
      const [receipts, setReceipts] = useState(loaded?.receipts || seedReceipts);

      // persist
      useEffect(()=>{
        saveState({clients,contracts,dueItems,receipts});
      },[clients,contracts,dueItems,receipts]);

      // compute stats
      const statsByClient = useMemo(()=>{
        const out={};
        for (const c of clients) out[c.id] = { due:0, paid:0, balance:0, currency:defaultCurrency(c.country) };
        for (const d of dueItems){ const o=out[d.clientId]; if(!o) continue; o.due += Number(d.amount)-Number(d.allocated||0); o.currency = d.currency || o.currency; }
        for (const r of receipts){ const o=out[r.clientId]; if(!o) continue; o.paid += Number(r.amount); o.currency = r.currency || o.currency; }
        for (const id in out) out[id].balance = out[id].due - out[id].paid;
        return out;
      },[clients,dueItems,receipts]);

      const filteredClients = useMemo(()=>{
        const t = search.trim().toLowerCase();
        let list = clients.filter(c => clientTab==="all" ? true : (clientTab==="current" ? c.status==="current" : c.status!=="current"));
        if (!t) return list;
        return list.filter(c => [c.name,c.email,c.phone,c.country].join(" ").toLowerCase().includes(t));
      }, [clients, clientTab, search]);

      // CRUD helpers
      const addClient = (obj)=> setClients(p=>[...p, {id:uid(), ...obj}]);
      const updateClient = (idOrPatch, patch)=> {
        // allow call as (id, patch) or from ClientView (patch only)
        if (typeof idOrPatch === "string") {
          setClients(p=>p.map(c=> c.id===idOrPatch? {...c, ...patch}:c));
        } else {
          // called as updateClient(patch) inside ClientView with closure
          const idx = clients.findIndex(c=>c.id===patch.id);
          if (idx>=0) setClients(p=>p.map(c=> c.id===patch.id? {...c, ...idOrPatch}:c));
        }
      };

      const addContract = (ct)=>{
        const n = { id:uid(), createdAt: new Date().toISOString(), ...ct };
        setContracts(p=>[n, ...p]);
        // convert prospect to current automatically
        setClients(p=>p.map(c=> c.id===ct.clientId ? {...c, status:"current"} : c));
      };
      const updateContract = (id, patch)=> setContracts(p=>p.map(c=> c.id===id? {...c, ...patch}:c));

      const addDue = (d)=> setDueItems(p=>[{...d, id:uid()}, ...p]);
      const alloc = (dueId, amount)=> setDueItems(p=>p.map(d=> d.id===dueId ? {...d, allocated: Math.min(Number(d.amount), Number(d.allocated||0)+Number(amount)), status: (Number(d.allocated||0)+Number(amount))>=Number(d.amount)?'paid':'partial'} : d));

      const addReceipt = (r)=>{
        const rec = { id:uid(), ...r, createdBy: currentUser };
        if (rec.appliedToDueItemId) alloc(rec.appliedToDueItemId, rec.amount);
        setReceipts(p=>[rec, ...p]);
      };

      const sortedContracts = useMemo(()=> [...contracts].sort((a,b)=> (b.createdAt||"") > (a.createdAt||"") ? 1 : -1 ), [contracts]);

      // export/import
      const exportJSON = ()=>{
        const data = {clients,contracts,dueItems,receipts};
        const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "qm-crm-backup.json"; a.click();
        URL.revokeObjectURL(url);
      };
      const importJSON = (file)=>{
        const reader = new FileReader();
        reader.onload = ()=> {
          try {
            const data = JSON.parse(reader.result);
            if (!data || typeof data !== "object") throw new Error("Bad JSON");
            setClients(Array.isArray(data.clients)? data.clients : []);
            setContracts(Array.isArray(data.contracts)? data.contracts : []);
            setDueItems(Array.isArray(data.dueItems)? data.dueItems : []);
            setReceipts(Array.isArray(data.receipts)? data.receipts : []);
            alert("تم الاستيراد بنجاح");
          } catch (e) { alert("ملف غير صالح"); }
        };
        reader.readAsText(file);
      };

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
            <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
              <div className="font-semibold text-slate-900 text-lg">QM Vendor/Client CRM — Sprint 5</div>
              <nav className="flex items-center gap-1 ml-2">
                {["clients","contracts","dues","receipts","reports"].map(id => (
                  <button key={id} onClick={()=>setTab(id)} className={"px-3 py-1.5 rounded-full text-sm border " + (tab===id? "bg-slate-900 text-white border-slate-900":"bg-white text-slate-700 border-slate-300")}>
                    {({clients:"العملاء",contracts:"العقود",dues:"المستحقات",receipts:"التحصيل",reports:"التقارير"})[id]}
                  </button>
                ))}
              </nav>
              <div className="ml-auto flex items-center gap-2">
                <input type="file" accept="image/*" className="hidden" id="logoUp" onChange={(e)=>{const f=e.target.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>setLogoDataUrl(reader.result); reader.readAsDataURL(f);}}/>
                <label className="btn" htmlFor="logoUp">Upload Logo</label>

                <input className="inp w-64" placeholder="...بحث في العملاء" value={search} onChange={e=>setSearch(e.target.value)} />

                <button className="btn" onClick={exportJSON}>Export JSON</button>
                <label className="btn">
                  Import JSON
                  <input type="file" accept="application/json" className="hidden" onChange={(e)=>{const f=e.target.files?.[0]; if(f) importJSON(f);}}/>
                </label>
              </div>
            </div>
          </header>

          <main className="mx-auto max-w-7xl px-4 pb-24">
            {tab==="clients" && (
              <ClientsPanel
                clients={filteredClients}
                allClients={clients}
                setClients={setClients}
                statsByClient={statsByClient}
                addClient={addClient}
                updateClient={(id,patch)=>setClients(p=>p.map(c=> c.id===id? {...c, ...patch}:c))}
                clientTab={clientTab}
                setClientTab={setClientTab}
                contracts={sortedContracts}
                addContract={addContract}
                dueItems={dueItems}
                addDue={addDue}
                receipts={receipts}
                exportClient={(clientId)=>{
                  const c = clients.find(x=>x.id===clientId);
                  exportClientPDF(
                    c,
                    sortedContracts.filter(ct=>ct.clientId===clientId),
                    dueItems.filter(d=>d.clientId===clientId),
                    receipts.filter(r=>r.clientId===clientId),
                    logoDataUrl
                  );
                }}
              />
            )}
            {tab==="contracts" && (
              <ContractsPanel
                clients={clients}
                contracts={sortedContracts}
                addContract={addContract}
                updateContract={updateContract}
              />
            )}
            {tab==="dues" && (
              <DuesPanel
                clients={clients}
                dueItems={dueItems}
                addDueItem={addDue}
                alloc={alloc}
              />
            )}
            {tab==="receipts" && (
              <ReceiptsPanel
                clients={clients}
                receipts={receipts}
                addReceipt={addReceipt}
                dueItems={dueItems}
              />
            )}
            {tab==="reports" && (
              <ReportsPanel
                clients={clients}
                dueItems={dueItems}
                receipts={receipts}
                exportPDF={(rows,title)=>{
                  const { jsPDF } = window.jspdf;
                  const doc = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
                  if (logoDataUrl) doc.addImage(logoDataUrl, "PNG", 40, 28, 90, 40);
                  doc.setFontSize(16); doc.text(title||"Reports", 140, 50);
                  doc.autoTable({ startY:80, head:[rows[0]], body: rows.slice(1) });
                  doc.save("qm_reports.pdf");
                }}
              />
            )}
          </main>
        </div>
      );
    }

    // ---------- Render ----------
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
  <!-- === [APP] END === -->
</body>
</html>
