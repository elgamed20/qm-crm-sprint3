<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QM Vendor/Client CRM — Sprint 4</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { background:#f8fafc; color:#0f172a; }
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;border:1px solid #cbd5e1;background:#fff;padding:.375rem .75rem;font-size:.875rem}
    .btn:hover{background:#f8fafc}
    .btn-primary{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;background:#0f172a;padding:.5rem 1rem;font-size:.875rem;color:#fff}
    .btn-primary:hover{background:#000}
    .btn-xs{display:inline-flex;align-items:center;justify-content:center;border-radius:.375rem;border:1px solid #cbd5e1;background:#fff;padding:.25rem .5rem;font-size:.75rem}
    .inp{width:100%;border:1px solid #cbd5e1;border-radius:.5rem;padding:.375rem .75rem;font-size:.875rem}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .card{border:1px solid #e2e8f0;background:#fff;border-radius:.75rem;padding:1rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .badge{display:inline-flex;align-items:center;border:1px solid #e2e8f0;border-radius:9999px;font-size:12px;padding:.125rem .5rem}
    .badge.gray{background:#f8fafc;color:#334155}
    .badge.amber{background:#fffbeb;color:#92400e;border-color:#f59e0b}
    .badge.green{background:#ecfdf5;color:#065f46;border-color:#34d399}
    .tabs button{border-radius:9999px;padding:.5rem 1rem;border:1px solid #cbd5e1}
    .tabs .active{background:#0f172a;color:#fff;border-color:#0f172a}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // --------- Constants / Utils ---------
    const currencies = [
      { code: "KWD", label: "Kuwaiti Dinar" },
      { code: "EGP", label: "Egyptian Pound" },
      { code: "AED", label: "UAE Dirham" },
      { code: "USD", label: "US Dollar" },
    ];
    const countries = ["الكويت","مصر","الإمارات","أخرى"];
    const contractTypes = [
      { value:"monthly", label:"شهري" },
      { value:"milestone", label:"دفعات (Milestones)" },
      { value:"mixed", label:"مختلط" },
    ];
    const dueCategories = ["دفع","تسويق","خدمات","أخرى"];
    const payMethods = ["تحويل بنكي","كاش","شيك","بوابة دفع","أخرى"];
    const stages = ["New","Contacted","Negotiation","Won","Lost"];
    const importanceLabels = ["High","Medium","Low"];
    const currencyByCountry = {"الكويت":"KWD","مصر":"EGP","الإمارات":"AED"};
    const defaultCurrency = c => currencyByCountry[c] || "USD";
    const uid = () => Math.random().toString(36).slice(2,10);
    const fmt = (n, code="KWD") => {
      if (Number.isNaN(Number(n))) return "-";
      try { return new Intl.NumberFormat(undefined,{style:"currency",currency:code,maximumFractionDigits:3}).format(Number(n)); }
      catch { return Number(n).toFixed(2)+" "+code; }
    };

    // --------- Seed Data ---------
    const seedClients = [
      { id: uid(), name: "Al Noor Clinic", country: "الكويت", phone: "22093334", email: "info@alnoor.kw", status: "current" },
      { id: uid(), name: "Delta Foods", country: "مصر", phone: "+2010000000", email: "ops@delta.eg",
        status: "prospect", salesOwner:"Omar", importance:"High", services:["Digital Marketing"], stage:"Negotiation",
        nextFollowUp:"", timeline:[] },
    ];
    const seedContracts = [
      { id: uid(), clientId: seedClients[0].id, service:"Marketing Retainer", type:"monthly", currency:"KWD",
        monthlyAmount:600, startDate:"2025-09-01", autoMonthly:true, billingDay:1, dueDay:5, createdAt:"2025-09-01" },
    ];
    const seedDue = [
      { id: uid(), clientId: seedClients[0].id, contractId: null, title:"اشتراك سبتمبر 2025",
        dueDate:"2025-09-05", amount:600, currency:"KWD", category:"دفع", allocated:0, status:"open" },
    ];
    const seedReceipts = [];

    // --------- PDF Helpers ---------
    const exportClientPDF = (client, contracts, dues, receipts, logo=null) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
      if (logo) doc.addImage(logo, "PNG", 40, 28, 90, 40);
      doc.setFontSize(16); doc.text("Client Statement", 140, 50);
      doc.setFontSize(11); doc.text(`Client: ${client.name}`, 40, 90);

      // Contracts
      let y = 110;
      doc.text("Contracts", 40, y);
      doc.autoTable({
        startY: y+10,
        head: [["Service","Type","Currency","Total/Monthly"]],
        body: contracts.map(ct => [
          ct.service || "-",
          ct.type,
          ct.currency,
          ct.type==="monthly" ? ct.monthlyAmount : (ct.total || (ct.milestones||[]).reduce((s,m)=>s+Number(m.amount||0),0) || 0)
        ])
      });

      // Dues
      y = doc.lastAutoTable.finalY + 20;
      doc.text("Dues", 40, y);
      doc.autoTable({
        startY: y+10,
        head: [["Title","Due Date","Amount","Status"]],
        body: dues.map(d => [d.title, d.dueDate, `${d.amount} ${d.currency}`, d.status])
      });

      // Receipts
      y = doc.lastAutoTable.finalY + 20;
      doc.text("Receipts", 40, y);
      doc.autoTable({
        startY: y+10,
        head: [["Date","Method","Amount","Reference","By"]],
        body: receipts.map(r => [r.receivedAt, r.method, `${r.amount} ${r.currency}`, r.reference||"-", r.createdBy||"-"])
      });

      // Totals
      const totalDue = dues.reduce((s,d)=> s + (Number(d.amount)-Number(d.allocated||0)), 0);
      const totalPaid = receipts.reduce((s,r)=> s + Number(r.amount), 0);
      const bal = totalDue - totalPaid;
      y = doc.lastAutoTable.finalY + 25;
      doc.setFontSize(12);
      doc.text(`Total Due: ${totalDue}`, 40, y);
      doc.text(`Total Paid: ${totalPaid}`, 180, y);
      doc.text(`Balance: ${bal}`, 320, y);

      doc.save(`${client.name}-statement.pdf`);
    };

    // --------- Small UI helpers ---------
    const Field = ({label,children}) => (
      <label className="grid gap-1 text-sm">
        <span className="text-slate-700 font-medium">{label}</span>
        {children}
      </label>
    );
    const Stat = ({label,value,subtle,highlight,good})=>{
      const cls = highlight? "bg-rose-50 border-rose-200": good? "bg-emerald-50 border-emerald-200": subtle? "bg-slate-50 border-slate-200":"bg-white border-slate-200";
      return <div className={"rounded-lg border p-3 text-center "+cls}>
        <div className="text-xs text-slate-600">{label}</div>
        <div className="text-base font-semibold">{value}</div>
      </div>;
    };
    const Th = ({children}) => <th className="px-3 py-2 text-xs font-semibold text-slate-600">{children}</th>;
    const Td = ({children}) => <td className="px-3 py-2">{children}</td>;
    const RowView = ({label,value}) => (
      <div className="flex items-center justify-between border-b py-2">
        <div className="text-sm text-slate-600">{label}</div>
        <div className="font-medium">{value || "—"}</div>
      </div>
    );
    const Modal = ({title,onClose,children}) => (
      <div className="modal" onMouseDown={onClose}>
        <div className="w-full max-w-2xl rounded-2xl bg-white border border-slate-200" onMouseDown={(e)=>e.stopPropagation()}>
          <div className="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <div className="font-semibold">{title}</div>
            <button className="text-slate-500 hover:text-slate-900" onClick={onClose}>✕</button>
          </div>
          <div className="p-4">{children}</div>
        </div>
      </div>
    );
    const ListTable = ({head,rows}) => (
      <div className="overflow-x-auto bg-white border rounded-xl">
        <table className="w-full text-sm">
          <thead className="bg-slate-50"><tr>{head.map((h,i)=><Th key={i}>{h}</Th>)}</tr></thead>
        <tbody>{rows.map((r,i)=>(<tr key={i} className="border-t">{r.map((c,j)=><Td key={j}>{c}</Td>)}</tr>))}</tbody>
        </table>
      </div>
    );

    // --------- Forms ---------
    const ClientForm = ({ onSubmit, initial, onCancel }) => {
      const [name,setName]=useState(initial?.name||"");
      const [country,setCountry]=useState(initial?.country||countries[0]);
      const [phone,setPhone]=useState(initial?.phone||"");
      const [email,setEmail]=useState(initial?.email||"");
      const [isProspect,setIsProspect]=useState(initial? initial.status!=="current" : true);
      const [salesOwner,setSalesOwner]=useState(initial?.salesOwner||"");
      const [importance,setImportance]=useState(initial?.importance||"Medium");
      const [services,setServices]=useState(initial?.services||[]);
      const [stage,setStage]=useState(initial?.stage||"New");

      return (
        <form onSubmit={(e)=>{e.preventDefault();
            onSubmit({ name, country, phone, email, status: isProspect? "prospect":"current",
              salesOwner, importance, services, stage
            });
          }} className="grid gap-3">
          <Field label="اسم العميل"><input className="inp" value={name} onChange={e=>setName(e.target.value)} required/></Field>
          <div className="grid grid-cols-2 gap-3">
            <Field label="الدولة"><select className="inp" value={country} onChange={e=>setCountry(e.target.value)}>{countries.map(cc=><option key={cc}>{cc}</option>)}</select></Field>
            <Field label="Prospect?"><input type="checkbox" checked={isProspect} onChange={e=>setIsProspect(e.target.checked)} /></Field>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="هاتف"><input className="inp" value={phone} onChange={e=>setPhone(e.target.value)} /></Field>
            <Field label="إيميل"><input className="inp" value={email} onChange={e=>setEmail(e.target.value)} /></Field>
          </div>
          {isProspect && (
            <>
              <div className="grid grid-cols-3 gap-3">
                <Field label="Sales Owner"><input className="inp" value={salesOwner} onChange={e=>setSalesOwner(e.target.value)} /></Field>
                <Field label="Importance"><select className="inp" value={importance} onChange={e=>setImportance(e.target.value)}>{importanceLabels.map(i=><option key={i}>{i}</option>)}</select></Field>
                <Field label="Stage"><select className="inp" value={stage} onChange={e=>setStage(e.target.value)}>{stages.map(s=><option key={s}>{s}</option>)}</select></Field>
              </div>
              <Field label="Services (comma separated)"><input className="inp" value={services.join(", ")} onChange={e=>setServices(e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} /></Field>
            </>
          )}
          <div className="flex justify-end gap-2">
            {onCancel && <button type="button" className="btn" onClick={onCancel}>إلغاء</button>}
            <button type="submit" className="btn-primary">حفظ</button>
          </div>
        </form>
      );
    };

    const ContractForm = ({ clients=[], onSubmit, initial, onCancel }) => {
      const [clientId,setClientId]=useState(initial?.clientId || (clients[0]?.id||""));
      const [service,setService]=useState(initial?.service||"");
      const [type,setType]=useState(initial?.type||"monthly");
      const [currency,setCurrency]=useState(initial?.currency||"KWD");
      const [monthlyAmount,setMonthlyAmount]=useState(initial?.monthlyAmount||600);
      const [startDate,setStartDate]=useState(initial?.startDate||"");
      const [endDate,setEndDate]=useState(initial?.endDate||"");
      const [autoMonthly,setAutoMonthly]=useState(!!initial?.autoMonthly);
      const [billingDay,setBillingDay]=useState(initial?.billingDay||1);
      const [dueDay,setDueDay]=useState(initial?.dueDay||5);
      const [milestones,setMilestones]=useState(initial?.milestones||[]);
      const addMilestone = ()=> setMilestones(p=>[...p, {id:uid(), title:"", amount:0, dueDate:"", status:"open", allocated:0}]);
      const setM = (i, patch)=> setMilestones(p=>p.map((m,idx)=> idx===i? {...m, ...patch}:m));
      const delM = (i)=> setMilestones(p=>p.filter((_,idx)=> idx!==i));

      return (
        <form onSubmit={(e)=>{ e.preventDefault();
            if(!clientId) return alert("اختر عميلًا");
            const payload={ clientId, service, type, currency, startDate, endDate, autoMonthly,
              billingDay:Number(billingDay), dueDay:Number(dueDay) };
            if (type==="monthly") payload.monthlyAmount=Number(monthlyAmount);
            if (type==="milestone") payload.milestones=milestones;
            onSubmit(payload);
          }} className="grid gap-3">
          {!!clients.length && <Field label="العميل"><select className="inp" value={clientId} onChange={e=>setClientId(e.target.value)}>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></Field>}
          <Field label="نوع الخدمة"><input className="inp" value={service} onChange={e=>setService(e.target.value)} placeholder="مثال: Social Media, SEO..." /></Field>
          <div className="grid grid-cols-2 gap-3">
            <Field label="نوع العقد"><select className="inp" value={type} onChange={e=>setType(e.target.value)}>{contractTypes.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select></Field>
            <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
          </div>
          {type==="monthly" && <Field label="قيمة الاشتراك الشهري"><input type="number" className="inp" value={monthlyAmount} onChange={e=>setMonthlyAmount(e.target.value)} /></Field>}
          <div className="grid grid-cols-2 gap-3">
            <Field label="تاريخ البداية"><input type="date" className="inp" value={startDate} onChange={e=>setStartDate(e.target.value)} /></Field>
            <Field label="تاريخ النهاية"><input type="date" className="inp" value={endDate} onChange={e=>setEndDate(e.target.value)} /></Field>
          </div>
          {type!=="milestone" && (
            <div className="grid grid-cols-3 gap-3">
              <Field label="توليد تلقائي"><input type="checkbox" checked={autoMonthly} onChange={e=>setAutoMonthly(e.target.checked)} /></Field>
              <Field label="يوم الإصدار"><input type="number" className="inp" value={billingDay} onChange={e=>setBillingDay(e.target.value)} /></Field>
              <Field label="يوم الاستحقاق"><input type="number" className="inp" value={dueDay} onChange={e=>setDueDay(e.target.value)} /></Field>
            </div>
          )}
          {type==="milestone" && (
            <div className="grid gap-2">
              <div className="flex items-center justify-between">
                <div className="font-semibold">دفعات (Milestones)</div>
                <button type="button" className="btn" onClick={addMilestone}>+ Add milestone</button>
              </div>
              {milestones.length===0 && <div className="text-sm text-slate-500">لا توجد دفعات بعد.</div>}
              {milestones.map((m,i)=>(
                <div key={m.id} className="grid grid-cols-5 gap-2 items-end">
                  <Field label="Title"><input className="inp" value={m.title} onChange={e=>setM(i,{title:e.target.value})} /></Field>
                  <Field label="Due Date"><input type="date" className="inp" value={m.dueDate} onChange={e=>setM(i,{dueDate:e.target.value})} /></Field>
                  <Field label="Amount"><input type="number" className="inp" value={m.amount} onChange={e=>setM(i,{amount:Number(e.target.value)})} /></Field>
                  <Field label="Status"><select className="inp" value={m.status} onChange={e=>setM(i,{status:e.target.value})}><option>open</option><option>partial</option><option>paid</option></select></Field>
                  <button type="button" className="btn" onClick={()=>delM(i)}>حذف</button>
                </div>
              ))}
            </div>
          )}
          <div className="flex justify-end gap-2">
            {onCancel && <button type="button" className="btn" onClick={onCancel}>إلغاء</button>}
            <button type="submit" className="btn-primary">حفظ</button>
          </div>
        </form>
      );
    };

    const DueForm = ({ clients, onSubmit, initial={} }) => {
      const [clientId, setClientId] = useState(initial.clientId || (clients[0]?.id || ""));
      const [title, setTitle] = useState(initial.title || "");
      const [dueDate, setDueDate] = useState(initial.dueDate || "");
      const [amount, setAmount] = useState(initial.amount || 0);
      const [currency, setCurrency] = useState(initial.currency || (clients[0] ? defaultCurrency(clients[0].country) : "KWD"));
      const [category, setCategory] = useState(initial.category || "دفع");
      return (
        <form onSubmit={(e)=>{e.preventDefault();
            if(!clientId) return alert("اختر العميل");
            if(!title.trim()) return alert("الوصف مطلوب");
            onSubmit({ id:uid(), clientId, title, dueDate, amount:Number(amount), currency, category, allocated:0, status:"open" });
          }} className="grid gap-3">
          <Field label="العميل"><select className="inp" value={clientId} onChange={e=>{ setClientId(e.target.value); const c=clients.find(x=>x.id===e.target.value); if(c) setCurrency(defaultCurrency(c.country)); }}>
            {clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select></Field>
          <Field label="الوصف"><input className="inp" value={title} onChange={e=>setTitle(e.target.value)} /></Field>
          <Field label="تاريخ الاستحقاق"><input type="date" className="inp" value={dueDate} onChange={e=>setDueDate(e.target.value)} /></Field>
          <Field label="القيمة"><input type="number" className="inp" value={amount} onChange={e=>setAmount(e.target.value)} /></Field>
          <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
          <Field label="التصنيف"><select className="inp" value={category} onChange={e=>setCategory(e.target.value)}>{dueCategories.map(x=><option key={x} value={x}>{x}</option>)}</select></Field>
          <div className="flex justify-end"><button type="submit" className="btn-primary">حفظ</button></div>
        </form>
      );
    };

    const ReceiptForm = ({ clients, dueItems, onSubmit, initial={} }) => {
      const [clientId, setClientId] = useState(initial.clientId || (clients[0]?.id || ""));
      const [amount, setAmount] = useState(initial.amount || 0);
      const [currency, setCurrency] = useState(initial.currency || (clients[0]? defaultCurrency(clients[0].country):"KWD"));
      const [method, setMethod] = useState(initial.method || payMethods[0]);
      const [reference, setReference] = useState(initial.reference || "");
      const [receivedAt, setReceivedAt] = useState(initial.receivedAt || new Date().toISOString().slice(0,10));
      const [note, setNote] = useState(initial.note || "");
      const [attachmentUrl, setAttachmentUrl] = useState(initial.attachmentUrl || "");
      const [appliedToDueItemId, setAppliedToDueItemId] = useState(initial.appliedToDueItemId || "");

      return (
        <form onSubmit={(e)=>{ e.preventDefault();
            if(!clientId) return alert("اختر العميل");
            if(Number(amount)<=0) return alert("القيمة غير صالحة");
            if(!attachmentUrl) return alert("إثبات الدفع إلزامي");
            onSubmit({
              clientId, amount:Number(amount), currency, method, reference, receivedAt, note,
              attachmentUrl, appliedToDueItemId: appliedToDueItemId || null
            });
          }} className="grid gap-3">
          <Field label="العميل"><select className="inp" value={clientId} onChange={e=>{ setClientId(e.target.value); const c=clients.find(x=>x.id===e.target.value); if(c) setCurrency(defaultCurrency(c.country)); }}>
            {clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select></Field>
          <div className="grid grid-cols-2 gap-3">
            <Field label="القيمة"><input type="number" className="inp" value={amount} onChange={e=>setAmount(e.target.value)} /></Field>
            <Field label="العملة"><select className="inp" value={currency} onChange={e=>setCurrency(e.target.value)}>{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></Field>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="طريقة الدفع"><select className="inp" value={method} onChange={e=>setMethod(e.target.value)}>{payMethods.map(m=><option key={m}>{m}</option>)}</select></Field>
            <Field label="مرجع"><input className="inp" value={reference} onChange={e=>setReference(e.target.value)} placeholder="رقم تحويل/شيك" /></Field>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="تاريخ التحصيل"><input type="date" className="inp" value={receivedAt} onChange={e=>setReceivedAt(e.target.value)} /></Field>
            <Field label="ملاحظة"><input className="inp" value={note} onChange={e=>setNote(e.target.value)} placeholder="اختياري" /></Field>
          </div>
          <Field label="مرفق (صورة/PDF)">
            <input type="file" accept="image/*,application/pdf" className="inp"
              onChange={(e)=>{const f=e.target.files?.[0]; if(f) setAttachmentUrl(URL.createObjectURL(f));}} />
          </Field>
          <Field label="تطبيق التحصيل على مستحق معيّن (اختياري)">
            <select className="inp" value={appliedToDueItemId} onChange={e=>setAppliedToDueItemId(e.target.value)}>
              <option value="">— لا يوجد —</option>
              {dueItems.filter(d=>d.clientId===clientId).map(d=><option key={d.id} value={d.id}>{d.title}</option>)}
            </select>
          </Field>
          <div className="flex justify-end"><button type="submit" className="btn-primary">حفظ</button></div>
        </form>
      );
    };

    // --------- Views ---------
    const ContractView = ({ ct, editable, onEdit }) => {
      const [edit,setEdit]=useState(false);
      if (!edit) {
        return (
          <div className="grid gap-2">
            <RowView label="Service" value={ct.service||"—"} />
            <RowView label="Type" value={ct.type} />
            <RowView label="Currency" value={ct.currency} />
            {ct.type==="monthly" && <RowView label="Monthly Amount" value={ct.monthlyAmount} />}
            <RowView label="Start"
